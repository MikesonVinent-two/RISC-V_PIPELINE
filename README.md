# 计算机组成与体系结构课程项目 (复旦大学, 2025春季)

本项目是为复旦大学2025年春季学期《计算机组成与体系结构（荣誉）》课程设计的RISC-V处理器核与SoC。项目旨在通过一系列循序渐进的实验，让学生从零开始，亲手构建一个功能完备、支持虚拟内存的现代五级流水线处理器。

项目代码托管于：[https://gitlab.com/fudan-systa/arch-2025](https://gitlab.com/fudan-systa/arch-2025)

## 核心功能与特色

本处理器基于RISC-V RV64I指令集架构，并通过一系列实验逐步扩展，最终实现了一个功能丰富的SoC。

- **五级流水线架构**: 采用经典的"取指(IF) - 译码(ID) - 执行(EX) - 访存(MEM) - 写回(WB)"流水线结构，并处理了相关的数据冒险和控制冒险。
- **高性能计算单元**: 实现了独立的硬件乘法器和除法器，以加速复杂的算术运算。
- **分支预测**: 内置动态分支预测器，以减少分支指令对流水线性能的影响。
- **内存管理单元 (MMU)**: 支持Sv39分页机制，实现了虚拟内存管理，能够进行虚拟地址到物理地址的转换，为运行操作系统提供支持。
- **中断与异常处理**: 实现了完整的CLINT（核心本地中断器），支持M/S/U三种特权模式下的中断和异常处理机制。
- **哈佛结构与总线系统**: 采用指令总线(IBus)和数据总线(DBus)分离的哈佛结构，通过自定义的`CBus`总线及仲裁器进行片上通信，并通过`CBus-to-AXI`桥接器与外部AXI总线设备兼容。
- **完善的验证体系**:
    - **Verilator仿真**: 使用Verilator将SystemVerilog代码转换为C++模型，进行高速仿真。
    - **差分测试 (Difftest)**: 框架与NEMU参考模型进行指令级的状态对比，确保处理器设计的正确性。
    - **FPGA原型验证**: 提供完整的Vivado工程，支持在Basys 3开发板上进行硬件原型验证。

## 开发历程

本处理器的开发遵循课程实验的引导，是一个逐步迭代、功能累积的过程：
1.  **Lab1 & 2**: 实现基本的RISC-V整数指令集与五级流水线，并处理数据冒险。
2.  **Lab3**: 解决控制冒险，实现跳转与分支指令。
3.  **Lab4**: 实现基本的CSR（控制状态寄存器）读写与异常处理。
4.  **Lab5 & 6**: 实现完整的中断机制、虚拟内存管理（MMU）以及特权模式。
5.  **Lab+**: 探索并实现原子指令、多核等高级功能。

## 目录结构

```
.
├── difftest/       # 差分测试框架，用于与NEMU进行对比验证
├── ready-to-run/   # 预编译的测试程序二进制文件和NEMU参考模型
├── verilate/       # Verilator仿真环境的C++封装和驱动代码
├── vivado/         # Vivado FPGA工程，用于硬件综合与实现
├── vsrc/           # 核心RTL代码 (SystemVerilog)
│   ├── include/    # Verilog头文件 (配置、总线定义等)
│   ├── src/        # CPU核心模块 (流水线各阶段、乘除法器等)
│   └── util/       # 总线组件 (仲裁器、MMU、AXI桥等)
├── Makefile        # 项目编译、仿真、测试的入口
└── README.md       # 本文件
```

## 环境依赖

- **Verilator**: 用于将Verilog/SystemVerilog编译为C++仿真模型。
- **C++编译器**: 需要支持C++11标准的编译器 (如GCC, Clang)。
- **(可选) Xilinx Vivado**: 如果需要进行FPGA原型验证。

## 编译与运行

本项目使用 `Makefile` 进行统一的构建和测试管理。

### 1. 初始化

首次克隆项目后，需要初始化git子模块（如果项目使用到的话）：
```bash
make init
```

### 2. 编译仿真器

所有测试都依赖于Verilator生成的仿真器。`Makefile`会自动处理编译过程。运行任何测试目标时，会首先检查并构建仿真器。编译产物将存放于`build/`目录下。

### 3. 运行测试

`Makefile`为每个实验提供了特定的测试目标。你可以通过运行以下命令来执行相应实验的测试程序：

```bash
# 运行实验一的测试
make test-lab1

# 运行实验二的测试
make test-lab2

# 运行实验三的测试
make test-lab3

# 运行实验四的测试
make test-lab4

# 运行实验五的测试 (运行内核)
make test-lab5

# 运行实验六的测试
make test-lab6
```

测试过程中，仿真器会加载`ready-to-run/`目录中对应的`.bin`文件，并与`riscv64-nemu-interpreter-so`参考模型进行差分测试，打印指令执行的log和最终的测试结果。

### 4. 清理

清理所有编译生成的文件：
```bash
make clean
```