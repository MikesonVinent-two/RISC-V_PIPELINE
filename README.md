# 高性能RISC-V流水线处理器 (复旦大学体系结构课程项目)

本项目是为复旦大学2025年春季学期《计算机组成与体系结构（荣誉）》课程设计的、一个功能完备的高性能RISC-V处理器核与SoC。项目从最基础的指令集开始，通过一系列精心设计的实验，最终实现了一个支持虚拟内存、具备动态分支预测和精准异常处理能力的现代五级流水线处理器。

项目代码托管于：[https://github.com/MikesonVinent-two/RISC-V_PIPELINE](https://github.com/MikesonVinent-two/RISC-V_PIPELINE)

## 技术亮点

- **完整五级流水线与冒险处理**: 实现了经典的IF-ID-EX-MEM-WB五级流水线，并通过**数据前推 (Forwarding)** 和**冒险检测与流水线暂停 (Stall)** 机制，高效地解决了数据冒险和控制冒险，保证了指令执行的正确性和流畅性。

- **动态分支预测**: 内置了一个高性能的动态分支预测器，包含**分支目标缓冲 (BTB)** 和一个基于**两位饱和计数器 (2-bit Saturating Counter)** 的模式历史表 (PHT)。该预测器能在程序运行时学习分支行为模式，有效降低分支指令带来的性能开销。

- **支持虚拟内存的MMU**: 实现了基于**Sv39分页标准**的内存管理单元 (MMU)，能够将虚拟地址转换为物理地址。核心组件包括一个硬件**页表遍历器 (Page Table Walker)** 和一个用于缓存地址映射的**TLB (Translation Lookaside Buffer)**，为运行现代操作系统提供了基础。

- **完整的中断与特权级支持**: 支持RISC-V定义的M（机器）、S（监管）和U（用户）三级特权模式。实现了**CLINT (Core-Local Interrupt Controller)**，能够处理时钟中断和软件中断，并实现了精准异常机制，确保在任何指令处发生异常都能被正确捕获和处理。

## 架构与功能详解

### 1. 处理器微架构

处理器核心 (`core.sv`) 采用经典的五级流水线结构，各阶段通过流水线寄存器进行隔离和信息传递。

- **IF (取指)**: 根据PC值从指令总线获取指令。包含与分支预测器的交互逻辑，以获取预测的下一PC地址。
- **ID (译码)**: 解析指令，生成控制信号，读取寄存器堆。本阶段集成了冒险检测单元，是流水线暂停控制的核心。
- **EX (执行)**: 执行算术逻辑运算。数据前推逻辑在此阶段最为复杂，确保EX和MEM阶段的结果能被后续指令及时使用。
- **MEM (访存)**: 通过数据总线与内存或外设进行交互。对于内存操作指令，本阶段完成地址计算和数据读写。
- **WB (写回)**: 将执行结果或从内存读取的数据写回通用寄存器堆。

### 2. 指令集与特权模式

- **指令集**: 支持 **RV64IM** 指令集。
    - `I`: 基础整数指令集。
    - `M`: 硬件乘除法指令扩展。
- **特权架构**: 完整实现了RISC-V的特权架构。
    - **CSRs**: 实现了包括`mstatus`, `mepc`, `mcause`, `mtvec`, `satp`等在内的核心控制状态寄存器。
    - **模式切换**: 支持通过`ecall`, `mret`, `sret`等指令在M/S/U模式间进行切换。

### 3. 高性能运算单元

- **乘法器 (`multiplier.sv`)**: 采用多周期并行乘法器设计，能够在一个或多个周期内完成64位整数乘法。
- **除法器 (`divider.sv`)**: 实现了"试商法"的硬件除法器，支持有符号和无符号除法运算，相比软件实现有巨大性能提升。

### 4. 内存与总线系统

- **哈佛结构**: 独立的指令总线(IBus)和数据总线(DBus)能够有效避免取指和访存操作的结构性冲突。
- **MMU (`MMU_module.sv`)**:
    - **Sv39分页**: 支持三级页表结构，能够管理 \\(2^{39}\\) 字节的虚拟地址空间。
    - **TLB**: 实现了一个全相联的TLB来缓存最近的虚实地址映射，加速地址翻译过程。TLB Miss时，硬件页表遍历器会自动查询内存中的页表。
- **总线架构**:
    - 核内`CBus`总线通过仲裁器 (`CBusArbiter.sv`) 合并IBus和DBus的请求。
    - `CBusToAXI.sv` 转换桥将`CBus`协议转换为业界标准的AXI4-Lite协议，便于与外部IP核集成。

### 5. 验证体系

项目配备了工业界常用的多层次验证手段，确保设计的正确性。
- **Verilator仿真**: 使用Verilator将SystemVerilog代码转换为高性能的C++模型，用于快速的功能迭代和调试。
- **差分测试 (Difftest)**: 搭建了与`NEMU`模拟器进行指令级同步执行和状态对比的差分测试框架。每一条指令执行后，都会比对通用寄存器和PC值的状态，是保证处理器逻辑正确性的关键。
- **FPGA原型验证**: 提供了完整的Vivado工程 (`vivado/`)，支持将设计综合并下载到Basys 3开发板上，进行真实的硬件环境测试。

## 开发历程

本处理器的开发遵循课程实验的引导，是一个逐步迭代、功能累积的过程：
1.  **Lab1 & 2**: 实现基本的RISC-V整数指令集与五级流水线，并处理数据冒险。
2.  **Lab3**: 解决控制冒险，实现跳转与分支指令。
3.  **Lab4**: 实现基本的CSR（控制状态寄存器）读写与异常处理。
4.  **Lab5 & 6**: 实现完整的中断机制、虚拟内存管理（MMU）以及特权模式。
5.  **Lab+**: 探索并实现原子指令、多核等高级功能。

## 目录结构

```
.
├── difftest/       # 差分测试框架，用于与NEMU进行对比验证
├── ready-to-run/   # 预编译的测试程序二进制文件和NEMU参考模型
├── verilate/       # Verilator仿真环境的C++封装和驱动代码
├── vivado/         # Vivado FPGA工程，用于硬件综合与实现
├── vsrc/           # 核心RTL代码 (SystemVerilog)
│   ├── include/    # Verilog头文件 (配置、总线定义等)
│   ├── src/        # CPU核心模块 (流水线各阶段、乘除法器等)
│   └── util/       # 总线组件 (仲裁器、MMU、AXI桥等)
├── Makefile        # 项目编译、仿真、测试的入口
└── README.md       # 本文件
```

## 环境依赖

- **Verilator**: 用于将Verilog/SystemVerilog编译为C++仿真模型。
- **C++编译器**: 需要支持C++11标准的编译器 (如GCC, Clang)。
- **(可选) Xilinx Vivado**: 如果需要进行FPGA原型验证。

## 编译与运行

本项目使用 `Makefile` 进行统一的构建和测试管理。

### 1. 初始化

首次克隆项目后，需要初始化git子模块（如果项目使用到的话）：
```bash
make init
```

### 2. 编译仿真器

所有测试都依赖于Verilator生成的仿真器。`Makefile`会自动处理编译过程。运行任何测试目标时，会首先检查并构建仿真器。编译产物将存放于`build/`目录下。

### 3. 运行测试

`Makefile`为每个实验提供了特定的测试目标。你可以通过运行以下命令来执行相应实验的测试程序：

```bash
# 运行实验一的测试
make test-lab1

# 运行实验二的测试
make test-lab2

# 运行实验三的测试
make test-lab3

# 运行实验四的测试
make test-lab4

# 运行实验五的测试 (运行内核)
make test-lab5

# 运行实验六的测试
make test-lab6
```

测试过程中，仿真器会加载`ready-to-run/`目录中对应的`.bin`文件，并与`riscv64-nemu-interpreter-so`参考模型进行差分测试，打印指令执行的log和最终的测试结果。

### 4. 清理

清理所有编译生成的文件：
```bash
make clean
```